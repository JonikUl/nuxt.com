---
title: 'Nuxt в периферийных средах'
description: "Узнайте, как мы сделали Nuxt 3 способным работать в периферийных средах выполнения, чтобы обеспечить рендеринг на стороне сервера рядом с вашими пользователями."
image: /assets/blog/nuxt-on-the-edge.png
authors:
  - name: Себастьян Шопен
    avatarUrl: https://github.com/atinux.png
    link: https://twitter.com/atinux
    twitter: atinux
date: 2023-07-13
category: Статья
---

## Введение

В сентябре 2017 года Cloudflare [представила Cloudflare Workers](https://blog.cloudflare.com/introducing-cloudflare-workers/), что дает возможность запускать JavaScript в их [периферийной сети](https://www.cloudflare.com/network/). Это означает, что ваш код будет развернут во всей периферийной сети в более чем ста местах по всему миру примерно за 30 секунд. Эта технология позволяет вам сосредоточиться на написании приложения рядом с вашими пользователями, где бы они ни находились в мире (задержка ~50 мс).

Среда выполнения воркера отличается от Node.js или браузера, он выполняет код с помощью V8, движка JavaScript, разработанного Google Chrome. До сих пор на их платформе можно было запускать только небольшие скрипты, запускаемые на периферии перед подключением к вашему серверу, например, для повышения производительности или добавления некоторой логики, основанной на заголовках запросов.

В ноябре 2020 года, работая над Nuxt 3, **мы сделали ставку на запуск Nuxt в продакшен-среде на периферийных средах выполнения/изолятах V8**.

Он открывает возможность серверного рендеринга страниц примерно за 50 мс из любой точки мира при использовании платформы вроде CloudFlare Workers, без необходимости иметь дело с серверами, балансировщиками нагрузки и кэшированием, примерно за [$0,3 за миллион запросов](https://developers.cloudflare.com/workers/platform/pricing/). На сегодняшний день появляются новые платформы, позволяющие запускать приложения на изолятах V8, например Deno Deploy.

::callout{icon="i-ph-info-duotone" color="blue"}
**Обновление 2024 года:** Я выпустил [NuxtHub](https://hub.nuxt.com), чтобы вы могли создавать полнофункциональные приложения с Nuxt на периферии, в вашей учетной записи Cloudflare с нулевой конфигурацией. Он включает в себя базу данных, хранилище BLOB-объектов, KV, удаленное хранилище и многое другое.
::

## Испытание

Чтобы Nuxt работал в воркерах, нам пришлось переписать некоторые части Nuxt, сделав их независимыми от среды (работающими в Node.js, браузере или V8).

Мы начали с нашего сервера и создали [unjs/h3](http://github.com/unjs/h3): минимальный http-фреймворк, созданный для высокой производительности и переносимости. Он заменяет [Connect](https://github.com/senchalabs/connect), который мы использовали в Nuxt 2, но совместим с ним, поэтому вы можете продолжать использовать middleware Connect/Express. В воркерах для каждого входящего запроса он запускает Nuxt в продакшене, отправляет ему запрос и отправляет обратно ответ.

В Nuxt 2 продолжительность запуска сервера в продакшен среде в памяти (также называемый холодным запуском) составляла около ~300 мс, поскольку для обработки запроса нам приходилось загружать все зависимости сервера и приложения.

Работая над h3, мы решили разделить код каждого обработчика, прикрепленного к серверу, и загружать их только по запросу. Когда вы запускаете Nuxt 3, мы загружаем в память только h3 и соответствующие обработчики. Когда поступает запрос, мы загружаем обработчик, соответствующий маршруту, и выполняем его.

:video{src="https://res.cloudinary.com/nuxt/video/upload/v1689236511/nuxt3/nuxt3-server-performance.mp4" poster="https://res.cloudinary.com/nuxt/video/upload/v1689236511/nuxt3/nuxt3-server-performance.jpg" controls}

Применив этот подход, **мы сократили время холодного запуска с ~300 мс до ~2 мс**.

У нас была еще одна проблема, чтобы запустить Nuxt на периферии: размер продакшен-бандла. Он включает сервер, приложение Vue и зависимости Node.js. В настоящее время рабочие процессы Cloudflare имеют ограничение в 1 МБ (бесплатный план) и 5 ​​МБ (план за 5 долларов в месяц) для размера воркера.

Чтобы добиться этого, мы создали [unjs/nitro](https://nitro.unjs.io/), наш серверный движок, при запуске команды `nuxt build` он объединяет весь ваш проект и включает все зависимости в конечный вывод. Он использует [Rollup](https://rollupjs.org/) и [vercel/nft](https://github.com/vercel/nft) для отслеживания кода, используемого `node_modules`, чтобы удалить ненужный код. **Общий размер сгенерированного вывода для базового приложения Nuxt 3 составляет около 700 КБ gzip.**

Наконец, чтобы обеспечить одинаковый опыт разработки между разработкой (Node.js) и продакшеном в Cloudflare (распределенная среда выполнения), мы создали [unjs/unenv](https://github.com/unjs/unenv): библиотеку для преобразования кода JavaScript для запуска в любом месте (независимо от платформы) путем имитации или добавления полифиллов для известных зависимостей.

**В Nuxt мы считаем, что у вас должна быть свобода выбора хостинг-провайдера, который подходит вам лучше всего.**

Вот почему вы можете развернуть приложение Nuxt с рендерингом на периферии на:
- [NuxtHub](https://hub.nuxt.com)
- [Cloudflare Page](https://nitro.unjs.io/deploy/providers/cloudflare#cloudflare-pages)
- [Deno Deploy](https://nitro.unjs.io/deploy/providers/deno-deploy)
- [Vercel Edge Functions](https://nitro.unjs.io/deploy/providers/vercel#vercel-edge-functions) (использует CloudFlare Workers под капотом)
- [Netlify Edge Functions](https://nitro.unjs.io/deploy/providers/netlify#netlify-edge-functions) (использует Deno под капотом)

Мы также поддерживаем многих других поставщиков услуг развертывания, включая [статический хостинг](/docs/getting-started/deployment#static-hosting) или [традиционные бессерверные и серверные хосты Node.js](/docs/getting-started/deployment#nodejs-server).

## Расширение fullstack-возможностей

Теперь, когда у нас есть Nuxt, работающий в распределенном рантайме, мы можем сделать больше, чем просто отрисовать приложение Vue. Благодаря [директории server](/docs/guide/directory-structure/server), создание маршрута API — это файл TypeScript.

Чтобы добавить маршрут `/api/hello`, создайте файл `server/api/hello.ts`:

```ts [server/api/hello.ts]
export default defineEventHandler((event) => {
  return {
    hello: 'мир'
  }
})
```

Теперь вы можете повсеместно вызывать этот API на своих страницах и в компонентах:


```vue [pages/index.vue]
<script setup>
const { data } = await useFetch('/api/hello')
</script>

<template>
  <pre>{{ data }}</pre>
</template>
```

Важно отметить одну вещь, которую мы учитывали при создании [useFetch](/docs/api/composables/use-fetch) и [$fetch](/docs/api/utils/dollarfetch), — это то, что во время рендеринга на стороне сервера, если вы вызываете маршруты API, он будет эмулировать запрос и вызывать код функции напрямую: **избегая HTTP-запроса и сокращая время рендеринга страницы**.

С точки зрения опыта разработчика, вы заметите, что при создании серверных файлов сервер Nuxt продолжает работать без пересборки приложения Vue. *** Это связано с тем, что Nuxt 3 поддерживает горячую замену модулей (HMR) при создании API и серверных маршрутов.**

Кроме того, используя объектно-реляционное отображение (ORM), такое как [drizzle-orm](https://orm.drizzle.team/), разработчики могут подключать периферийные и бессерверные базы данных, такие как [D1](https://developers.cloudflare.com/d1/), [Turso](https://turso.tech/), [Neon](https://neon.tech), [Planetscale](https://planetscale.com/) и другие.

Я создал [Nuxt Todos Edge](https://nuxt-todos-edge.pages.dev/), демо-версию с открытым исходным кодом, чтобы продемонстрировать полнофункциональное приложение с аутентификацией и базой данных, работающей на периферийных серверах. Исходный код доступен на GitHub по лицензии MIT по адресу [atinux/nuxt-todos-edge](https://github.com/atinux/nuxt-todos-edge).

## Заключение

Мы в восторге от рендеринга на распределенных серверах и от того, что он открывает. Наша команда в Nuxt с нетерпением ждет возможности увидеть, что вы построите на основе этого!

Не стесняйтесь присоединяться к нашему [серверу Discord](https://discord.com/invite/nuxt) или упоминать [@nuxt_js](https://twitter.com/nuxt_js) в Twitter, чтобы поделиться своей работой.
